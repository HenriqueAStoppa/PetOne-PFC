<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Hospitalar - PetOne</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'verde-claro': '#d8f3dc',
                        'verde-card': '#b7e4c7',
                        'verde-escuro': '#1b4332',
                        'verde-escuro-hover': '#163326',
                    },
                    fontFamily: { sans: ['Poppins', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .modal { display: none; }
        .modal.flex { display: flex; }
    </style>
</head>
<body class="min-h-screen text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-30 border-b border-gray-200">
        <nav class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-sm mr-2">H</div>
                <span class="text-xl font-bold text-blue-900">Painel Hospitalar</span>
            </div>
            <div class="flex items-center gap-4">
                <span id="user-nome-nav" class="hidden md:inline text-sm font-medium text-gray-600">Hospital</span>
                <a href="./index.html" class="text-gray-600 hover:text-blue-700 font-medium text-sm">Home</a>
                <button id="btn-logout" class="text-red-600 hover:text-red-800 text-sm font-medium flex items-center gap-1">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Sair
                </button>
            </div>
        </nav>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-10">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-lg font-bold text-blue-900 flex items-center gap-2">
                            <i data-lucide="building-2" class="w-5 h-5"></i> Dados da Unidade
                        </h2>
                        <button id="btn-unlock-profile" class="text-blue-600 hover:text-blue-800 text-xs font-bold uppercase" title="Habilitar Edição">Editar</button>
                    </div>
                    
                    <form id="form-perfil" class="space-y-3 text-sm">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Nome Fantasia</label><input type="text" id="nome" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500 focus:border-blue-500" required disabled></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">CNPJ</label><input type="text" id="cnpj" class="w-full p-2 border rounded bg-gray-100 text-gray-500 cursor-not-allowed" readonly></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Email</label><input type="text" id="email" class="w-full p-2 border rounded bg-gray-100 text-gray-500 cursor-not-allowed" readonly></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Telefone</label><input type="text" id="telefone" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500 focus:border-blue-500" required disabled></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Endereço</label><input type="text" id="endereco" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500 focus:border-blue-500" required disabled></div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">Vet. Resp.</label><input type="text" id="vet" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500 focus:border-blue-500" required disabled></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase">CRMV</label><input type="text" id="crmv" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500 focus:border-blue-500" required disabled></div>
                        </div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase">Classificação (1-4)</label><input type="number" min="1" max="4" id="classificacao" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500 focus:border-blue-500" required disabled></div>
                        
                        <button type="submit" id="btn-save-profile" class="w-full bg-blue-700 text-white py-2 rounded-lg hover:bg-blue-800 transition font-bold text-xs uppercase hidden">Salvar Alterações</button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100 min-h-[600px]">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold text-blue-900 flex items-center gap-2">
                            <i data-lucide="activity" class="w-6 h-6 text-red-500"></i> Chamados de Emergência
                        </h2>
                        <button onclick="carregarLogs()" class="text-sm font-medium text-blue-600 hover:text-blue-800 flex items-center gap-1"><i data-lucide="refresh-cw" class="w-4 h-4"></i> Atualizar</button>
                    </div>
                    
                    <div id="lista-logs" class="space-y-4">
                        <p class="text-gray-500 text-center py-10">Carregando...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-finalizar" class="modal fixed inset-0 bg-black bg-opacity-60 z-50 items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-2xl relative transform transition-all scale-100">
            <button onclick="document.getElementById('modal-finalizar').style.display='none'" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <h3 class="text-2xl font-bold text-green-900 mb-2 flex items-center gap-2">
                <i data-lucide="check-circle" class="w-6 h-6"></i> Finalizar Atendimento
            </h3>
            
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-6 text-sm">
                <p><span class="font-bold text-gray-600">Token:</span> <span id="modal-token" class="font-mono text-black font-bold text-lg"></span></p>
            </div>

            <form id="form-finalizar" class="space-y-4">
                <input type="hidden" id="finalizar-token-input">
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Relatório Médico *</label>
                    <textarea id="relatorio" rows="5" class="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500 bg-gray-50" placeholder="Descreva o procedimento realizado, diagnóstico e o estado atual do animal..." required></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">Prescrição / Medicamentos</label>
                    <textarea id="prescricao" rows="3" class="w-full p-3 border rounded-lg focus:ring-green-500 focus:border-green-500 bg-gray-50" placeholder="Medicamentos receitados e orientações para o tutor..."></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Vet. Responsável *</label>
                        <input type="text" id="finalizar-vet" class="w-full p-2 border rounded-lg bg-gray-50" required>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">CRMV *</label>
                        <input type="text" id="finalizar-crmv" class="w-full p-2 border rounded-lg bg-gray-50" required>
                    </div>
                </div>
                
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-md mt-4 transition transform active:scale-95">
                    Concluir Atendimento
                </button>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        const API_URL = 'http://localhost:8080/api';
        const token = localStorage.getItem('petone_token');
        
        if (!token) {
            alert("Sessão expirada ou não encontrada. Faça login novamente.");
            window.location.href = 'pages/login/index.html';
        }

        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...options.headers, 'Authorization': `Bearer ${token}` };
            try {
                const response = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('petone_token');
                    window.location.href = 'pages/login/index.html';
                    return null;
                }
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `Erro na requisição: ${response.status}`);
                }
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error("Erro API:", error);
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            carregarPerfil();
            carregarLogs();
        });

        document.getElementById('btn-logout').onclick = () => {
            localStorage.removeItem('petone_token');
            localStorage.removeItem('petone_user_nome');
            localStorage.removeItem('petone_user_id');
            window.location.href = 'pages/login/index.html';
        };

        async function carregarPerfil() {
            try {
                const h = await apiFetch('/hospital/me');
                if (h) {
                    document.getElementById('nome').value = h.nomeFantasia;
                    document.getElementById('cnpj').value = h.cnpj;
                    document.getElementById('email').value = h.emailHospital;
                    document.getElementById('telefone').value = h.telefoneHospital;
                    document.getElementById('endereco').value = h.endereco;
                    document.getElementById('vet').value = h.veterinarioResponsavel;
                    document.getElementById('crmv').value = h.crmvVeterinario;
                    document.getElementById('classificacao').value = h.classificacaoServico;
                    
                    const nomeNav = localStorage.getItem('petone_user_nome');
                    if(nomeNav) document.getElementById('user-nome-nav').textContent = nomeNav;
                }
            } catch(e) { 
                console.error("Erro ao carregar perfil:", e);
            }
        }

        document.getElementById('btn-unlock-profile').onclick = function() {
            const inputs = document.querySelectorAll('#form-perfil input:not([readonly])');
            const btnSave = document.getElementById('btn-save-profile');
            const isDisabled = inputs[0].disabled;
            
            inputs.forEach(i => i.disabled = !isDisabled);
            btnSave.classList.toggle('hidden');
            this.textContent = isDisabled ? "Cancelar" : "Editar";
            
            if(!isDisabled) carregarPerfil(); 
        };

        document.getElementById('form-perfil').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                nomeFantasia: document.getElementById('nome').value,
                telefoneHospital: document.getElementById('telefone').value,
                endereco: document.getElementById('endereco').value,
                veterinarioResponsavel: document.getElementById('vet').value,
                crmvVeterinario: document.getElementById('crmv').value,
                classificacaoServico: parseInt(document.getElementById('classificacao').value)
            };
            
            try { 
                await apiFetch('/hospital/me', { method: 'PUT', body: JSON.stringify(data) }); 
                alert('Perfil atualizado com sucesso!');
                document.getElementById('btn-unlock-profile').click();
            } catch(e){ 
                alert(`Erro ao salvar: ${e.message}`); 
            }
        };

        async function carregarLogs() {
            const div = document.getElementById('lista-logs');
            div.innerHTML = '<p class="text-gray-500 text-center py-4 animate-pulse">Buscando chamados...</p>';
            
            try {
                const logs = await apiFetch('/hospital/logs');
                
                if(!logs || logs.length === 0) { 
                    div.innerHTML = '<div class="bg-gray-50 border border-dashed border-gray-300 rounded-xl p-10 text-center text-gray-500">Nenhum chamado de emergência recebido ainda.</div>'; 
                    return; 
                }
                
                div.innerHTML = '';
                logs.sort((a, b) => {
                    if (a.status === 'Finalizado' && b.status !== 'Finalizado') return 1;
                    if (a.status !== 'Finalizado' && b.status === 'Finalizado') return -1;
                    return new Date(b.dataHoraInicio || b.dataHoraRegistro) - new Date(a.dataHoraInicio || a.dataHoraRegistro);
                });

                logs.forEach(l => {
                    const isFinalizado = l.status === 'Finalizado';
                    const dataHora = l.dataHoraInicio || l.dataHoraRegistro;
                    const dateStr = dataHora ? new Date(dataHora).toLocaleString('pt-BR') : 'Data desconhecida';

                    const card = document.createElement('div');
                    card.className = `p-5 rounded-xl border transition relative overflow-hidden ${isFinalizado ? 'bg-white border-gray-200 opacity-90' : 'bg-white border-red-200 shadow-md border-l-4 border-l-red-500'}`;
                    
                    card.innerHTML = `
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="font-mono font-bold ${isFinalizado ? 'text-gray-500' : 'text-red-600'} text-lg bg-gray-100 px-2 py-1 rounded">${l.tokenEmergencia}</span>
                                    <span class="text-xs px-2 py-1 rounded-full font-bold uppercase tracking-wide ${isFinalizado ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800 animate-pulse'}">${l.status}</span>
                                    <span class="text-xs text-gray-400 ml-auto md:ml-0">${dateStr}</span>
                                </div>
                                
                                <h4 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 ${isFinalizado ? 'text-gray-400' : 'text-red-500'}"></i> 
                                    ${l.tipoEmergencia || l.sintomaCausa}
                                </h4>
                                
                                <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                                    <p class="text-gray-600"><strong class="text-gray-800">Paciente:</strong> ${l.nomeAnimal} <span class="text-gray-400">(${l.especieAnimal})</span></p>
                                    <p class="text-gray-600"><strong class="text-gray-800">Tutor:</strong> ${l.nomeCompletoTutor}</p>
                                    <p class="text-gray-600"><strong class="text-gray-800">Contato:</strong> <a href="tel:${l.telefoneTutor}" class="text-blue-600 hover:underline font-medium">${l.telefoneTutor}</a></p>
                                </div>
                            </div>

                            <div class="w-full md:w-auto mt-2 md:mt-0 text-right">
                                ${!isFinalizado ? 
                                    `<button onclick="abrirFinalizar('${l.tokenEmergencia}')" class="w-full md:w-auto bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 shadow-sm text-sm font-bold uppercase tracking-wide flex items-center justify-center gap-2 transition transform hover:scale-105"><i data-lucide="check-square" class="w-4 h-4"></i> Atender</button>` : 
                                    `<div class="text-green-600 flex items-center gap-1 font-medium text-sm bg-green-50 px-3 py-2 rounded-lg border border-green-100 inline-block"><i data-lucide="check" class="w-4 h-4"></i> Concluído</div>`
                                }
                            </div>
                        </div>
                        
                        ${isFinalizado ? `
                            <div class="mt-4 pt-4 border-t border-gray-100 text-sm bg-gray-50 p-3 rounded-lg">
                                <p class="text-gray-700 mb-2"><strong class="text-blue-900 block mb-1">Relatório Médico:</strong> ${l.relatorioMedico || 'Nenhum relatório.'}</p>
                                ${l.prescricaoMedicamento ? `<p class="text-gray-700"><strong class="text-blue-900 block mb-1">Prescrição:</strong> ${l.prescricaoMedicamento}</p>` : ''}
                                <p class="text-xs text-gray-400 mt-3 text-right">Finalizado por: ${l.veterinarioFinalizacao} (CRMV: ${l.crmvFinalizacao})</p>
                            </div>
                        ` : ''}
                    `;
                    div.appendChild(card);
                });
                lucide.createIcons();
            } catch(e) { 
                div.innerHTML = `<p class="text-red-500 text-center">Erro ao carregar logs: ${e.message}</p>`; 
            }
        }

        window.abrirFinalizar = (token) => {
            document.getElementById('finalizar-token-input').value = token;
            document.getElementById('modal-token').innerText = token;
            
            const vetAtual = document.getElementById('vet').value;
            const crmvAtual = document.getElementById('crmv').value;
            if(vetAtual) document.getElementById('finalizar-vet').value = vetAtual;
            if(crmvAtual) document.getElementById('finalizar-crmv').value = crmvAtual;
            
            document.getElementById('modal-finalizar').style.display = 'flex';
        };

        document.getElementById('form-finalizar').onsubmit = async (e) => {
            e.preventDefault();
            const token = document.getElementById('finalizar-token-input').value;
            const data = {
                relatorio: document.getElementById('relatorio').value,
                prescricao: document.getElementById('prescricao').value,
                veterinarioResponsavelFinalizacao: document.getElementById('finalizar-vet').value,
                crmvVeterinarioFinalizacao: document.getElementById('finalizar-crmv').value
            };

            try {
                await apiFetch(`/emergencia/finalizar/${token}`, { method: 'PUT', body: JSON.stringify(data) });
                
                document.getElementById('modal-finalizar').style.display = 'none';
                document.getElementById('form-finalizar').reset();
                
                alert('Atendimento finalizado com sucesso!');
                carregarLogs();
            } catch(e) { 
                alert(`Erro ao finalizar: ${e.message}`); 
            }
        };
    </script>
</body>
</html>