<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetOne - Nova Emerg√™ncia</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --vermelho: #dc2626; --vermelho-claro: #fee2e2; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Poppins", sans-serif; }
    body { background-color: var(--vermelho-claro); color: #0f172a; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .container { width: 100%; max-width: 500px; }
    .card { background-color: white; border-radius: 16px; padding: 32px; box-shadow: 0 10px 25px rgba(220, 38, 38, 0.2); border-top: 6px solid var(--vermelho); }
    h1 { color: var(--vermelho); text-align: center; margin-bottom: 10px; }
    p.subtitle { text-align: center; color: #64748b; margin-bottom: 24px; font-size: 14px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; }
    select { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; background-color: white; }
    select:focus { border-color: var(--vermelho); outline: none; }
    .btn-emergencia { width: 100%; padding: 16px; background-color: var(--vermelho); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.1s; }
    .btn-emergencia:active { transform: scale(0.98); }
    .btn-voltar { display: block; text-align: center; margin-top: 20px; color: #64748b; text-decoration: none; font-size: 14px; }
    
    .modal-sucesso { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 38, 38, 0.95); align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
    .modal-content { background: white; padding: 40px 30px; border-radius: 24px; text-align: center; max-width: 400px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    
    .token-label { font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 5px; }
    .token-box { background: #fef2f2; padding: 15px; border-radius: 12px; margin-bottom: 25px; font-family: monospace; font-size: 32px; font-weight: 800; letter-spacing: 3px; color: var(--vermelho); border: 3px dashed var(--vermelho); user-select: all; }
    
    .hospital-info { margin-bottom: 25px; font-size: 15px; color: #334155; line-height: 1.5; }
    .hospital-name { display: block; font-weight: 700; font-size: 18px; color: #0f172a; margin-bottom: 4px; }
    
    .btn-maps { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 16px; background-color: #2563eb; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); transition: background 0.2s; text-decoration: none; }
    .btn-maps:hover { background-color: #1d4ed8; }
    
    .btn-close { background: transparent; border: none; color: #94a3b8; font-weight: 600; cursor: pointer; font-size: 14px; margin-top: 10px; }
    .btn-close:hover { color: #64748b; text-decoration: underline; }

    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>

  <div class="container">
    <div class="card">
      <h1>üö® Registro de Emerg√™ncia</h1>
      <p class="subtitle">Informe os dados para alertar a rede PetOne</p>
      
      <form id="formEmergencia">
        <div class="form-group">
          <label>Qual animal?</label>
          <select id="animal" required>
            <option value="" disabled selected>Carregando seus animais...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Qual o Sintoma Principal?</label>
          <select id="sintoma" required>
            <option value="" disabled selected>Selecione...</option>
            <option value="Hemorragia externa">Hemorragia externa</option>
            <option value="Convuls√£o">Convuls√£o</option>
            <option value="Engasgo/Obstru√ß√£o">Engasgo/Obstru√ß√£o</option>
            <option value="Rea√ß√µes al√©rgicas">Rea√ß√µes al√©rgicas</option>
            <option value="Trauma/Atropelamento">Trauma/Atropelamento</option>
            <option value="Desmaio">Desmaio</option>
            <option value="Envenenamento">Envenenamento</option>
            <option value="Parto dif√≠cil">Parto dif√≠cil</option>
            <option value="Outro">Outro</option>
          </select>
        </div>
        <button type="submit" class="btn-emergencia">SOLICITAR SOCORRO IMEDIATO</button>
      </form>
      <a href="dashboard_tutor.html" class="btn-voltar">Cancelar</a>
    </div>
  </div>

  <div id="modalSucesso" class="modal-sucesso">
    <div class="modal-content">
      <div style="font-size: 40px; margin-bottom: 10px;">üöë</div>
      <h2 style="color: #0f172a; margin-bottom: 20px; font-size: 22px; font-weight: 700;">Socorro Solicitado!</h2>
      
      <p class="token-label">Seu Token de Atendimento</p>
      <div id="tokenDisplay" class="token-box">...</div>
      
      <div class="hospital-info">
        <div>Hospital Destino:</div>
        <span id="hospitalNome" class="hospital-name">...</span>
        <span id="hospitalEndereco" style="font-size: 13px; color: #64748b;">...</span>
      </div>
      
      <a id="btnRota" href="#" target="_blank" class="btn-maps">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
        NAVEGAR AGORA
      </a>

      <button onclick="window.location.href='dashboard_tutor.html'" class="btn-close">Voltar ao Painel</button>
    </div>
  </div>

 <script>
  const API_URL = 'http://localhost:8080'; 
  
  const token = localStorage.getItem('petone_token');
  if(!token) window.location.href = 'pages/login/index.html';

  // Carregar animais
  fetch(`${API_URL}/api/animais`, { headers: { 'Authorization': `Bearer ${token}` } })
    .then(res => res.json())
    .then(animais => {
      const select = document.getElementById('animal');
      if(animais.length === 0) {
          select.innerHTML = '<option disabled>Nenhum animal cadastrado</option>';
          alert('Voc√™ precisa cadastrar um animal antes!');
          window.location.href = 'dashboard_tutor.html';
      } else {
          select.innerHTML = '<option value="" disabled selected>Selecione...</option>';
          animais.forEach(a => {
              select.innerHTML += `<option value="${a.idAnimal}">${a.nomeAnimal} (${a.especie})</option>`;
          });
      }
    })
    .catch(() => alert("Erro ao carregar animais. Verifique a conex√£o."));

  // Enviar emerg√™ncia
  document.getElementById('formEmergencia').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const btnSubmit = e.target.querySelector('button[type="submit"]');
      const textoOriginal = "SOLICITAR SOCORRO IMEDIATO";

      btnSubmit.disabled = true;
      btnSubmit.innerText = "Buscando hospital...";

      const idAnimal = document.getElementById('animal').value;
      const tipoEmergencia = document.getElementById('sintoma').value;

      if (!navigator.geolocation) {
        alert('Seu navegador n√£o suporta geolocaliza√ß√£o.');
        restaurarBotao();
        return;
      }

      const options = {
        enableHighAccuracy: true, 
        timeout: 10000,           
        maximumAge: 0            
      };

      navigator.geolocation.getCurrentPosition(async (position) => {
          const latitudeTutor = position.coords.latitude;
          const longitudeTutor = position.coords.longitude;
          
          const data = {
              idAnimal,
              tipoEmergencia,
              latitudeTutor,
              longitudeTutor
          };

          try {
              const res = await fetch(`${API_URL}/api/emergencia/iniciar`, {
                  method: 'POST',
                  headers: { 
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify(data)
              });

              if(res.ok) {
                  const result = await res.json();

                  // Token
                  document.getElementById('tokenDisplay').innerText = result.tokenEmergencia;

                  // Hospital
                  document.getElementById('hospitalNome').innerText = result.hospitalNome;
                  document.getElementById('hospitalEndereco').innerText = result.hospitalEndereco;

                  const enderecoCodificado = encodeURIComponent(result.hospitalEndereco);
                  
                  // CORRE√á√ÉO FINAL DA URL DO MAPS: Origin=Coordenadas, Destination=Endere√ßo
                  const mapsUrl =
                    `http://maps.google.com/maps?saddr=${latitudeTutor},${longitudeTutor}&daddr=${enderecoCodificado}&diraction=navigate`;

                  document.getElementById('btnRota').href = mapsUrl;

                  // Modal
                  document.getElementById('modalSucesso').style.display = 'flex';

              } else {
                  const erro = await res.text();
                  alert('Erro ao registrar emerg√™ncia: ' + erro);
                  restaurarBotao();
              }
          } catch(err) {
              console.error(err);
              alert('Erro de conex√£o com o servidor.');
              restaurarBotao();
          }
      }, (error) => {
          console.error(error);
          alert('N√£o foi poss√≠vel obter sua localiza√ß√£o. Libere a permiss√£o de localiza√ß√£o.');
          restaurarBotao();
      }, options);
      
      function restaurarBotao() {
          btnSubmit.disabled = false;
          btnSubmit.innerText = textoOriginal;
          btnSubmit.style.backgroundColor = ""; 
      }
  });
</script>
</body>
</html>